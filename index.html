<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name=".viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Frost Click: 10-Min Challenge</title>
  <!-- Web3.js -->
  <script src="https://unpkg.com/web3@1.10.0/dist/web3.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0c1445;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
    }
    #game {
      position: relative;
      width: 100vw;
      height: 100vh;
      cursor: pointer;
    }
    .object {
      position: absolute;
      top: -50px;
      font-size: 28px;
      user-select: none;
      text-align: center;
      width: 50px;
      transform: translateX(-50%);
    }
    .bomb {
      animation: blink 0.9s infinite;
    }
    @keyframes blink {
      0%, 45% { opacity: 1; }
      50%, 95% { opacity: 0.2; }
      100% { opacity: 1; }
    }
    #score {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      font-size: 24px;
      z-index: 10;
    }
    #timer {
      position: absolute;
      top: 20px;
      right: 20px;
      color: #4dffcc;
      font-size: 20px;
      z-index: 10;
    }
    #connect-wallet {
      position: absolute;
      top: 20px;
      right: 150px;
      width: 160px;
      padding: 6px 12px;
      font-size: 14px;
      background: #5d5dff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 10;
    }
    #submit-score {
      position: absolute;
      top: 60px;
      right: 150px;
      width: 160px;
      padding: 6px 12px;
      font-size: 14px;
      background: #ff994d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 10;
      display: none;
    }
    #show-leaderboard {
      position: absolute;
      top: 100px;
      right: 150px;
      width: 160px;
      padding: 6px 12px;
      font-size: 14px;
      background: #4dffcc;
      color: #000;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 10;
      display: none;
    }
    #game-over {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      display: none;
      z-index: 20;
    }
    #game-over h2 {
      margin-top: 0;
      color: #ffcc00;
    }
    .win h2 {
      color: #4dffcc !important;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 18px;
      background: #4dffb8;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #7affd0;
    }
  </style>
</head>
<body>
  <div id="game">
    <div id="score">Score: 0</div>
    <div id="timer">10:00</div>
    <button id="connect-wallet">Connect Wallet</button>
    <button id="submit-score">Submit Score</button>
    <button id="show-leaderboard">Show Top 10</button>
    <div id="game-over">
      <h2 id="result-title">Game Over!</h2>
      <p id="final-score">Your score: 0</p>
      <p id="time-survived">Time: 0s</p>
      <button id="restart">Play Again</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      // ‚ö†Ô∏è –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô –ê–î–†–ï–° –ö–û–ù–¢–†–ê–ö–¢–ê!
      const CONTRACT_ADDRESS = "0xE3d9AD4B407F7FdF6B6f2528188185686EAeac89";

      const game = document.getElementById('game');
      const scoreEl = document.getElementById('score');
      const timerEl = document.getElementById('timer');
      const gameOverEl = document.getElementById('game-over');
      const resultTitle = document.getElementById('result-title');
      const finalScoreEl = document.getElementById('final-score');
      const timeSurvivedEl = document.getElementById('time-survived');
      const restartBtn = document.getElementById('restart');
      const connectWalletBtn = document.getElementById('connect-wallet');
      const submitScoreBtn = document.getElementById('submit-score');
      const showLeaderboardBtn = document.getElementById('show-leaderboard');

      const GAME_DURATION = 10 * 60 * 1000;
      const SOMNIA_CHAIN_ID = '0x13af';  // 5031 in hex

      let score = 0;
      let gameActive = true;
      let isFrozen = false;
      let objects = [];
      let gameLoopId = null;
      let startTime = 0;
      let timerInterval = null;
      let userAccount = null;
      let web3 = null;
      let contract = null;

      const contractABI = [
        {
          "inputs": [{"name": "score", "type": "uint256"}],
          "name": "submitScore",
          "outputs": [],
          "stateMutability": "nonpayable",
          "type": "function"
        },
        {
          "inputs": [],
          "name": "getLeaderboard",
          "outputs": [{"name": "", "type": "tuple[100]"}],
          "stateMutability": "view",
          "type": "function",
          "components": [
            {"name": "player", "type": "address"},
            {"name": "score", "type": "uint256"},
            {"name": "timestamp", "type": "uint256"}
          ]
        }
      ];

      function updateScore() {
        scoreEl.textContent = `Score: ${score}`;
      }

      function formatTime(ms) {
        const totalSec = Math.floor(ms / 1000);
        const min = Math.floor(totalSec / 60);
        const sec = totalSec % 60;
        return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
      }

      function createObject(emoji, type, speed) {
        const obj = document.createElement('div');
        obj.className = 'object';
        if (type === 'bomb') obj.classList.add('bomb');
        obj.textContent = emoji;
        obj.style.left = Math.random() * (window.innerWidth - 50) + 'px';
        game.appendChild(obj);
        objects.push({ el: obj, type, y: -50, speed });
      }

      game.addEventListener('click', (e) => {
        if (!gameActive && !isFrozen) return;
        const x = e.clientX;
        const y = e.clientY;
        for (let i = objects.length - 1; i >= 0; i--) {
          const obj = objects[i];
          const rect = obj.el.getBoundingClientRect();
          let hit = false;
          if (obj.type === 'snow') {
            const hitbox = {
              left: rect.left - 25,
              right: rect.right + 25,
              top: rect.top - 25,
              bottom: rect.bottom + 25
            };
            hit = (x >= hitbox.left && x <= hitbox.right && y >= hitbox.top && y <= hitbox.bottom);
          } else {
            hit = (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
          }
          if (hit) {
            const type = obj.type;
            obj.el.remove();
            objects.splice(i, 1);
            if (isFrozen) {
              if (type === 'snow') score += 1;
              if (type === 'bomb') score += 3;
              if (type === 'gift') score += 5;
              if (type === 'ice') score += 2;
              updateScore();
              return;
            }
            if (type === 'bomb') {
              endGame(false);
              return;
            } else if (type === 'ice') {
              activateFreeze();
              score += 2;
            } else if (type === 'gift') {
              score += 5;
            } else {
              score += 1;
            }
            updateScore();
            return;
          }
        }
      });

      function activateFreeze() {
        if (isFrozen) return;
        isFrozen = true;
        const overlay = document.createElement('div');
        overlay.id = 'freeze-overlay';
        Object.assign(overlay.style, {
          position: 'absolute', top: '0', left: '0', width: '100%', height: '100%',
          background: 'rgba(200, 240, 255, 0.3)',
          pointerEvents: 'none',
          zIndex: '5'
        });
        game.appendChild(overlay);
        const freezeTimer = document.createElement('div');
        freezeTimer.id = 'freeze-timer';
        Object.assign(freezeTimer.style, {
          position: 'absolute', top: '50px', right: '20px',
          color: '#a0e0ff', fontSize: '20px', zIndex: '10'
        });
        freezeTimer.textContent = 'Freeze: 5s';
        game.appendChild(freezeTimer);
        let timeLeft = 5;
        const countdown = setInterval(() => {
          timeLeft--;
          if (timeLeft > 0) {
            freezeTimer.textContent = `Freeze: ${timeLeft}s`;
          } else {
            clearInterval(countdown);
            freezeTimer.remove();
            overlay.remove();
            isFrozen = false;
          }
        }, 1000);
      }

      function endGame(isWin) {
        gameActive = false;
        if (timerInterval) clearInterval(timerInterval);
        if (gameLoopId) cancelAnimationFrame(gameLoopId);
        const elapsed = Date.now() - startTime;
        resultTitle.textContent = isWin ? 'üéâ You Survived 10 Minutes! üéâ' : 'Game Over!';
        finalScoreEl.textContent = `Final Score: ${score}`;
        timeSurvivedEl.textContent = `Time: ${formatTime(elapsed)}`;
        gameOverEl.className = isWin ? 'win' : '';
        gameOverEl.style.display = 'block';
        if (userAccount) {
          submitScoreBtn.style.display = 'block';
        }
      }

      function gameLoop() {
        if (!gameActive && !isFrozen) return;
        for (let i = objects.length - 1; i >= 0; i--) {
          const obj = objects[i];
          if (!isFrozen) {
            obj.y += obj.speed * 0.016;
            obj.el.style.top = obj.y + 'px';
            if (obj.y > window.innerHeight) {
              obj.el.remove();
              objects.splice(i, 1);
            }
          }
        }
        if (gameActive) {
          if (Math.random() < 0.05) createObject('‚ùÑÔ∏è', 'snow', 110 + Math.random() * 90);
          if (Math.random() < 0.05) createObject('üí£', 'bomb', 110 + Math.random() * 90);
          if (Math.random() < 0.0035) createObject('üéÅ', 'gift', 70 + Math.random() * 40);
          if (Math.random() < 0.0025) createObject('üßä', 'ice', 60 + Math.random() * 30);
        }
        gameLoopId = requestAnimationFrame(gameLoop);
      }

      function startGame() {
        score = 0;
        gameActive = true;
        isFrozen = false;
        objects = [];
        startTime = Date.now();
        updateScore();
        timerEl.textContent = '10:00';
        gameOverEl.style.display = 'none';
        submitScoreBtn.style.display = 'none';
        showLeaderboardBtn.style.display = userAccount ? 'block' : 'none';
        document.getElementById('freeze-overlay')?.remove();
        document.getElementById('freeze-timer')?.remove();
        document.querySelectorAll('.object').forEach(el => el.remove());
        if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
          const elapsed = Date.now() - startTime;
          const remaining = GAME_DURATION - elapsed;
          if (remaining <= 0) {
            clearInterval(timerInterval);
            endGame(true);
          } else {
            timerEl.textContent = formatTime(remaining);
          }
        }, 1000);
        gameLoopId = requestAnimationFrame(gameLoop);
      }

      // ===== Web3 —Å –∑–∞—â–∏—Ç–æ–π —Å–µ—Ç–∏ Somnia =====
      async function initWeb3() {
        if (typeof window.ethereum === 'undefined') {
          alert('Please install MetaMask or Somnia Wallet!');
          return false;
        }

        try {
          const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
          if (currentChainId !== SOMNIA_CHAIN_ID) {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å
            await window.ethereum.request({
              method: 'wallet_switchEthereumChain',
              params: [{ chainId: SOMNIA_CHAIN_ID }]
            });
          }
        } catch (switchError) {
          if (switchError.code === 4902) {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ç—å
            try {
              await window.ethereum.request({
                method: 'wallet_addEthereumChain',
                params: [{
                  chainId: SOMNIA_CHAIN_ID,
                  chainName: 'Somnia Mainnet',
                  rpcUrls: ['https://api.infra.mainnet.somnia.network/'],
                  nativeCurrency: {
                    name: 'SOMI',
                    symbol: 'SOMI',
                    decimals: 18
                  },
                  blockExplorerUrls: ['https://explorer.somnia.network']
                }]
              });
            } catch (addError) {
              console.error(addError);
              alert('Failed to add Somnia network. Please add it manually.');
              return false;
            }
          } else {
            alert('Please switch to Somnia Mainnet in your wallet.');
            return false;
          }
        }

        web3 = new Web3(window.ethereum);
        return true;
      }

      connectWalletBtn.addEventListener('click', async () => {
        const ready = await initWeb3();
        if (!ready) return;
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          userAccount = accounts[0];
          connectWalletBtn.textContent = userAccount.substring(0, 6) + '...';
          contract = new web3.eth.Contract(contractABI, CONTRACT_ADDRESS);
          showLeaderboardBtn.style.display = 'block';
          if (!gameActive) {
            submitScoreBtn.style.display = 'block';
          }
        } catch (error) {
          console.error(error);
          alert('Wallet connection failed');
        }
      });

      submitScoreBtn.addEventListener('click', async () => {
        if (!contract || !userAccount) {
          alert('Connect wallet first');
          return;
        }
        if (score <= 0) {
          alert('Score is zero');
          return;
        }
        try {
          const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
          if (currentChainId !== SOMNIA_CHAIN_ID) {
            alert('Please stay on Somnia Mainnet!');
            return;
          }
          await contract.methods.submitScore(score).send({ from: userAccount });
          alert('‚úÖ Score submitted to Somnia Mainnet!');
        } catch (error) {
          console.error(error);
          alert('Submission failed. Check console for details.');
        }
      });

      // ===== –õ–∏–¥–µ—Ä–±–æ—Ä–¥ =====
      showLeaderboardBtn.addEventListener('click', async () => {
        if (!contract) {
          alert('Connect wallet first');
          return;
        }
        try {
          const leaderboard = await contract.methods.getLeaderboard().call();
          let html = '<h3>üèÜ Frost Click Top 10</h3><ol>';
          let count = 0;
          for (let entry of leaderboard) {
            if (entry.player !== '0x0000000000000000000000000000000000000000' && entry.score > 0) {
              const shortAddr = entry.player.substring(0, 6) + '...';
              html += `<li>${shortAddr}: ${entry.score}</li>`;
              count++;
              if (count >= 10) break;
            }
          }
          if (count === 0) html += '<li>No scores yet</li>';
          html += '</ol><button id="close-lb" style="margin-top:10px;padding:5px 10px;">Close</button>';

          const modal = document.createElement('div');
          modal.id = 'leaderboard-modal';
          modal.style.cssText = `
            position: fixed; top: 20%; left: 50%; transform: translateX(-50%);
            background: rgba(10, 20, 50, 0.95); color: white; padding: 20px; border-radius: 10px;
            z-index: 100; width: 300px; text-align: left;
          `;
          modal.innerHTML = html;
          document.body.appendChild(modal);

          document.getElementById('close-lb').onclick = () => modal.remove();
        } catch (error) {
          console.error(error);
          alert('Failed to load leaderboard');
        }
      });

      restartBtn.addEventListener('click', startGame);
      startGame();

    });
  </script>
</body>
</html>

