<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Frost Click: 10-Min Challenge</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #0c1445;
      overflow: hidden;
      font-family: 'Arial', sans-serif;
    }
    #game {
      position: relative;
      width: 100vw;
      height: 100vh;
      cursor: pointer;
    }
    .object {
      position: absolute;
      top: -50px;
      font-size: 28px;
      user-select: none;
      text-align: center;
      width: 50px;
      transform: translateX(-50%);
    }
    .bomb {
      animation: blink 0.9s infinite;
    }
    @keyframes blink {
      0%, 45% { opacity: 1; }
      50%, 95% { opacity: 0.2; }
      100% { opacity: 1; }
    }
    #score {
      position: absolute;
      top: 20px;
      left: 20px;
      color: white;
      font-size: 24px;
      z-index: 10;
    }
    #timer {
      position: absolute;
      top: 20px;
      right: 20px;
      color: #4dffcc;
      font-size: 20px;
      z-index: 10;
    }
    #connect-wallet {
      position: absolute;
      top: 20px;
      right: 150px;
      width: 160px;
      padding: 6px 12px;
      font-size: 14px;
      background: #5d5dff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 10;
    }
    #submit-score {
      position: absolute;
      top: 60px;
      right: 150px;
      width: 160px;
      padding: 6px 12px;
      font-size: 14px;
      background: #ff994d;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      z-index: 10;
      display: none;
    }
    #game-over {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      display: none;
      z-index: 20;
    }
    #game-over h2 {
      margin-top: 0;
      color: #ffcc00;
    }
    .win h2 {
      color: #4dffcc !important;
    }
    button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 18px;
      background: #4dffb8;
      color: #000;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #7affd0;
    }
  </style>
</head>
<body>
  <div id="game">
    <div id="score">Score: 0</div>
    <div id="timer">10:00</div>
    <button id="connect-wallet">Connect Wallet</button>
    <button id="submit-score">Submit Score</button>
    <div id="game-over">
      <h2 id="result-title">Game Over!</h2>
      <p id="final-score">Your score: 0</p>
      <p id="time-survived">Time: 0s</p>
      <button id="restart">Play Again</button>
    </div>
  </div>

  <script>
    // ===========================
    // âš ï¸ Ð’Ð¡Ð¢ÐÐ’Ð¬ Ð¡Ð®Ð”Ð ÐÐ”Ð Ð•Ð¡ Ð¡Ð’ÐžÐ•Ð“Ðž ÐšÐžÐÐ¢Ð ÐÐšÐ¢Ð ÐŸÐžÐ¡Ð›Ð• Ð”Ð•ÐŸÐ›ÐžÐ¯!
    // ÐŸÑ€Ð¸Ð¼ÐµÑ€: const CONTRACT_ADDRESS = "0xE3d9AD4B407F7FdF6B6f2528188185686EAeac89";
    // ===========================
    const CONTRACT_ADDRESS = "0x..."; // â† Ð—ÐÐœÐ•ÐÐ˜ Ð­Ð¢Ð£ Ð¡Ð¢Ð ÐžÐšÐ£!

    const game = document.getElementById('game');
    const scoreEl = document.getElementById('score');
    const timerEl = document.getElementById('timer');
    const gameOverEl = document.getElementById('game-over');
    const resultTitle = document.getElementById('result-title');
    const finalScoreEl = document.getElementById('final-score');
    const timeSurvivedEl = document.getElementById('time-survived');
    const restartBtn = document.getElementById('restart');
    const connectWalletBtn = document.getElementById('connect-wallet');
    const submitScoreBtn = document.getElementById('submit-score');

    const GAME_DURATION = 10 * 60 * 1000;

    let score = 0;
    let gameActive = true;
    let isFrozen = false;
    let objects = [];
    let gameLoopId = null;
    let startTime = 0;
    let timerInterval = null;
    let userAccount = null;
    let web3 = null;
    let contract = null;

    const contractABI = [
      {
        "inputs": [{"name": "score", "type": "uint256"}],
        "name": "submitScore",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    function updateScore() {
      scoreEl.textContent = `Score: ${score}`;
    }

    function formatTime(ms) {
      const totalSec = Math.floor(ms / 1000);
      const min = Math.floor(totalSec / 60);
      const sec = totalSec % 60;
      return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    function createObject(emoji, type, speed) {
      const obj = document.createElement('div');
      obj.className = 'object';
      if (type === 'bomb') obj.classList.add('bomb');
      obj.textContent = emoji;
      obj.style.left = Math.random() * (window.innerWidth - 50) + 'px';
      game.appendChild(obj);
      objects.push({ el: obj, type, y: -50, speed });
    }

    game.addEventListener('click', (e) => {
      if (!gameActive && !isFrozen) return;
      const x = e.clientX;
      const y = e.clientY;
      for (let i = objects.length - 1; i >= 0; i--) {
        const obj = objects[i];
        const rect = obj.el.getBoundingClientRect();
        let hit = false;
        if (obj.type === 'snow') {
          const hitbox = {
            left: rect.left - 25,
            right: rect.right + 25,
            top: rect.top - 25,
            bottom: rect.bottom + 25
          };
          hit = (x >= hitbox.left && x <= hitbox.right && y >= hitbox.top && y <= hitbox.bottom);
        } else {
          hit = (x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom);
        }
        if (hit) {
          const type = obj.type;
          obj.el.remove();
          objects.splice(i, 1);
          if (isFrozen) {
            if (type === 'snow') score += 1;
            if (type === 'bomb') score += 3;
            if (type === 'gift') score += 5;
            if (type === 'ice') score += 2;
            updateScore();
            return;
          }
          if (type === 'bomb') {
            endGame(false);
            return;
          } else if (type === 'ice') {
            activateFreeze();
            score += 2;
          } else if (type === 'gift') {
            score += 5;
          } else {
            score += 1;
          }
          updateScore();
          return;
        }
      }
    });

    function activateFreeze() {
      if (isFrozen) return;
      isFrozen = true;
      const overlay = document.createElement('div');
      overlay.id = 'freeze-overlay';
      Object.assign(overlay.style, {
        position: 'absolute', top: '0', left: '0', width: '100%', height: '100%',
        background: 'rgba(200, 240, 255, 0.3)',
        pointerEvents: 'none',
        zIndex: '5'
      });
      game.appendChild(overlay);
      const freezeTimer = document.createElement('div');
      freezeTimer.id = 'freeze-timer';
      Object.assign(freezeTimer.style, {
        position: 'absolute', top: '50px', right: '20px',
        color: '#a0e0ff', fontSize: '20px', zIndex: '10'
      });
      freezeTimer.textContent = 'Freeze: 5s';
      game.appendChild(freezeTimer);
      let timeLeft = 5;
      const countdown = setInterval(() => {
        timeLeft--;
        if (timeLeft > 0) {
          freezeTimer.textContent = `Freeze: ${timeLeft}s`;
        } else {
          clearInterval(countdown);
          freezeTimer.remove();
          overlay.remove();
          isFrozen = false;
        }
      }, 1000);
    }

    function endGame(isWin) {
      gameActive = false;
      if (timerInterval) clearInterval(timerInterval);
      if (gameLoopId) cancelAnimationFrame(gameLoopId);
      const elapsed = Date.now() - startTime;
      resultTitle.textContent = isWin ? 'ðŸŽ‰ You Survived 10 Minutes! ðŸŽ‰' : 'Game Over!';
      finalScoreEl.textContent = `Final Score: ${score}`;
      timeSurvivedEl.textContent = `Time: ${formatTime(elapsed)}`;
      gameOverEl.className = isWin ? 'win' : '';
      gameOverEl.style.display = 'block';
      if (userAccount) {
        submitScoreBtn.style.display = 'block';
      }
    }

    function gameLoop() {
      if (!gameActive && !isFrozen) return;
      for (let i = objects.length - 1; i >= 0; i--) {
        const obj = objects[i];
        if (!isFrozen) {
          obj.y += obj.speed * 0.016;
          obj.el.style.top = obj.y + 'px';
          if (obj.y > window.innerHeight) {
            obj.el.remove();
            objects.splice(i, 1);
          }
        }
      }
      if (gameActive) {
        if (Math.random() < 0.05) createObject('â„ï¸', 'snow', 110 + Math.random() * 90);
        if (Math.random() < 0.05) createObject('ðŸ’£', 'bomb', 110 + Math.random() * 90);
        if (Math.random() < 0.0035) createObject('ðŸŽ', 'gift', 70 + Math.random() * 40);
        if (Math.random() < 0.0025) createObject('ðŸ§Š', 'ice', 60 + Math.random() * 30);
      }
      gameLoopId = requestAnimationFrame(gameLoop);
    }

    function startGame() {
      score = 0;
      gameActive = true;
      isFrozen = false;
      objects = [];
      startTime = Date.now();
      updateScore();
      timerEl.textContent = '10:00';
      gameOverEl.style.display = 'none';
      submitScoreBtn.style.display = 'none';
      document.getElementById('freeze-overlay')?.remove();
      document.getElementById('freeze-timer')?.remove();
      document.querySelectorAll('.object').forEach(el => el.remove());
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const elapsed = Date.now() - startTime;
        const remaining = GAME_DURATION - elapsed;
        if (remaining <= 0) {
          clearInterval(timerInterval);
          endGame(true);
        } else {
          timerEl.textContent = formatTime(remaining);
        }
      }, 1000);
      gameLoopId = requestAnimationFrame(gameLoop);
    }

    // ===== Web3 Wallet Integration =====
    async function initWeb3() {
      if (typeof window.ethereum !== 'undefined') {
        web3 = new Web3(window.ethereum);
      } else {
        alert('Please install MetaMask or Somnia Wallet!');
        return false;
      }
      return true;
    }

    connectWalletBtn.addEventListener('click', async () => {
      const ready = await initWeb3();
      if (!ready) return;
      try {
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        userAccount = accounts[0];
        connectWalletBtn.textContent = userAccount.substring(0, 6) + '...';
        contract = new web3.eth.Contract(contractABI, CONTRACT_ADDRESS);
        if (!gameActive) {
          submitScoreBtn.style.display = 'block';
        }
      } catch (error) {
        console.error(error);
        alert('Wallet connection failed');
      }
    });

    submitScoreBtn.addEventListener('click', async () => {
      if (!contract || !userAccount) {
        alert('Connect wallet first');
        return;
      }
      if (score <= 0) {
        alert('Score is zero');
        return;
      }
      try {
        await contract.methods.submitScore(score).send({ from: userAccount });
        alert('âœ… Score submitted to Somnia Mainnet!');
      } catch (error) {
        console.error(error);
        alert('Submission failed. Check console for details.');
      }
    });

    restartBtn.addEventListener('click', startGame);
    startGame();
  </script>
</body>
</html>